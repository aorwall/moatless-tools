# django__django-14855

| **django/django** | `475cffd1d64c690cdad16ede4d5e81985738ceb4` |
| ---- | ---- |
| **No of patches** | 1 |
| **All found context length** | 31206 |
| **Any found context length** | 31206 |
| **Avg pos** | 104.0 |
| **Min pos** | 104 |
| **Max pos** | 104 |
| **Top file pos** | 7 |
| **Missing snippets** | 1 |
| **Missing patch files** | 0 |


## Expected patch

```diff
diff --git a/django/contrib/admin/helpers.py b/django/contrib/admin/helpers.py
--- a/django/contrib/admin/helpers.py
+++ b/django/contrib/admin/helpers.py
@@ -209,7 +209,11 @@ def get_admin_url(self, remote_field, remote_obj):
             remote_field.model._meta.model_name,
         )
         try:
-            url = reverse(url_name, args=[quote(remote_obj.pk)])
+            url = reverse(
+                url_name,
+                args=[quote(remote_obj.pk)],
+                current_app=self.model_admin.admin_site.name,
+            )
             return format_html('<a href="{}">{}</a>', url, remote_obj)
         except NoReverseMatch:
             return str(remote_obj)

```

## Expected file changes

| File | Start line | End line | Found on position | Found file position | Context length |
| ---- | ---------- | -------- | ----------------- | ------------------- | -------------- |
| django/contrib/admin/helpers.py | 212 | 212 | 104 | 7 | 31206


## Problem Statement

```
Wrong URL generated by get_admin_url for readonly field in custom Admin Site
Description
	
When a model containing a ForeignKey field is viewed (or edited) in a custom Admin Site, and that ForeignKey field is listed in readonly_fields, the url generated for the link is /admin/... instead of /custom-admin/....
This appears to be caused by the following line in django.contrib.admin.helpers get_admin_url:
url = reverse(url_name, args=[quote(remote_obj.pk)])
Other parts of the admin use the current_app keyword parameter to identify the correct current name of the Admin Site. (See django.contrib.admin.options.ModelAdmin response_add as just one example)
I have been able to correct this specific issue by replacing the above line with:
url = reverse(
	url_name,
	args=[quote(remote_obj.pk)],
	current_app=self.model_admin.admin_site.name
)
However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track.

```

## Retrieved code snippets

| Position | File | Start line | End line | Tokens | Sum tokens | File tokens |
| -------- | ---- | ---------- | -------- | ------ | ---------- | ----------- |
| 1 | 1 django/contrib/admin/options.py | 617 | 638| 258 | 258 | 18682 | 
| 2 | 2 django/contrib/admin/sites.py | 245 | 299| 516 | 774 | 23111 | 
| 3 | 2 django/contrib/admin/sites.py | 224 | 243| 221 | 995 | 23111 | 
| 4 | 3 django/contrib/admin/widgets.py | 161 | 192| 243 | 1238 | 26983 | 
| 5 | 3 django/contrib/admin/options.py | 1551 | 1637| 760 | 1998 | 26983 | 
| 6 | 3 django/contrib/admin/options.py | 1638 | 1663| 291 | 2289 | 26983 | 
| 7 | 3 django/contrib/admin/options.py | 1 | 96| 756 | 3045 | 26983 | 
| 8 | 3 django/contrib/admin/options.py | 1337 | 1362| 232 | 3277 | 26983 | 
| 9 | 3 django/contrib/admin/sites.py | 539 | 559| 185 | 3462 | 26983 | 
| 10 | 4 django/contrib/admin/checks.py | 608 | 619| 128 | 3590 | 36165 | 
| 11 | 4 django/contrib/admin/options.py | 1138 | 1183| 482 | 4072 | 36165 | 
| 12 | 4 django/contrib/admin/sites.py | 419 | 433| 129 | 4201 | 36165 | 
| 13 | 5 django/urls/base.py | 27 | 86| 438 | 4639 | 37348 | 
| 14 | 5 django/contrib/admin/options.py | 1766 | 1848| 750 | 5389 | 37348 | 
| 15 | 5 django/contrib/admin/options.py | 640 | 657| 128 | 5517 | 37348 | 
| 16 | 6 django/contrib/admin/utils.py | 289 | 307| 175 | 5692 | 41506 | 
| 17 | 6 django/contrib/admin/sites.py | 1 | 35| 225 | 5917 | 41506 | 
| 18 | 6 django/contrib/admin/options.py | 285 | 374| 636 | 6553 | 41506 | 
| 19 | **7 django/contrib/admin/helpers.py** | 217 | 250| 318 | 6871 | 44964 | 
| 20 | 8 django/contrib/admindocs/urls.py | 1 | 51| 307 | 7178 | 45271 | 
| 21 | 8 django/contrib/admin/options.py | 1694 | 1765| 653 | 7831 | 45271 | 
| 22 | 8 django/contrib/admin/utils.py | 444 | 472| 225 | 8056 | 45271 | 
| 23 | 9 django/contrib/admindocs/views.py | 187 | 253| 584 | 8640 | 48610 | 
| 24 | 9 django/contrib/admin/options.py | 1921 | 1974| 433 | 9073 | 48610 | 
| 25 | 10 django/contrib/admin/views/main.py | 275 | 305| 270 | 9343 | 53077 | 
| 26 | 10 django/contrib/admin/sites.py | 38 | 81| 339 | 9682 | 53077 | 
| 27 | 10 django/contrib/admin/options.py | 206 | 217| 135 | 9817 | 53077 | 
| 28 | 11 django/contrib/admin/templatetags/admin_urls.py | 1 | 57| 405 | 10222 | 53482 | 
| 29 | 11 django/contrib/admin/utils.py | 263 | 286| 174 | 10396 | 53482 | 
| 30 | 11 django/contrib/admin/options.py | 430 | 473| 350 | 10746 | 53482 | 
| 31 | 11 django/contrib/admindocs/views.py | 160 | 184| 234 | 10980 | 53482 | 
| 32 | 11 django/contrib/admindocs/views.py | 254 | 320| 589 | 11569 | 53482 | 
| 33 | 11 django/contrib/admin/sites.py | 562 | 576| 116 | 11685 | 53482 | 
| 34 | 11 django/contrib/admin/views/main.py | 509 | 540| 224 | 11909 | 53482 | 
| 35 | 11 django/contrib/admin/options.py | 99 | 129| 223 | 12132 | 53482 | 
| 36 | 11 django/contrib/admin/options.py | 376 | 428| 504 | 12636 | 53482 | 
| 37 | **11 django/contrib/admin/helpers.py** | 35 | 76| 282 | 12918 | 53482 | 
| 38 | 12 django/contrib/redirects/admin.py | 1 | 11| 0 | 12918 | 53550 | 
| 39 | 13 django/contrib/sites/managers.py | 1 | 61| 385 | 13303 | 53935 | 
| 40 | 13 django/contrib/admin/widgets.py | 326 | 344| 168 | 13471 | 53935 | 
| 41 | 14 django/contrib/admin/models.py | 136 | 151| 131 | 13602 | 55058 | 
| 42 | 15 django/contrib/auth/admin.py | 1 | 22| 188 | 13790 | 56795 | 
| 43 | 15 django/contrib/admin/options.py | 1472 | 1491| 133 | 13923 | 56795 | 
| 44 | 16 django/contrib/auth/urls.py | 1 | 21| 224 | 14147 | 57019 | 
| 45 | 16 django/contrib/admin/checks.py | 621 | 643| 155 | 14302 | 57019 | 
| 46 | 16 django/contrib/admin/options.py | 1518 | 1549| 295 | 14597 | 57019 | 
| 47 | 16 django/contrib/admin/options.py | 1665 | 1676| 151 | 14748 | 57019 | 
| 48 | 16 django/contrib/admin/options.py | 1029 | 1046| 184 | 14932 | 57019 | 
| 49 | 16 django/contrib/admindocs/views.py | 1 | 31| 234 | 15166 | 57019 | 
| 50 | 16 django/contrib/admin/checks.py | 904 | 952| 416 | 15582 | 57019 | 
| 51 | 17 django/urls/resolvers.py | 653 | 726| 681 | 16263 | 62811 | 
| 52 | 17 django/contrib/admin/options.py | 1850 | 1919| 590 | 16853 | 62811 | 
| 53 | **17 django/contrib/admin/helpers.py** | 100 | 128| 249 | 17102 | 62811 | 
| 54 | **17 django/contrib/admin/helpers.py** | 400 | 416| 138 | 17240 | 62811 | 
| 55 | 18 django/db/models/fields/reverse_related.py | 180 | 205| 269 | 17509 | 65131 | 
| 56 | 18 django/contrib/admin/options.py | 2186 | 2221| 315 | 17824 | 65131 | 
| 57 | 18 django/contrib/admin/options.py | 1493 | 1516| 319 | 18143 | 65131 | 
| 58 | 19 django/contrib/sites/admin.py | 1 | 9| 0 | 18143 | 65177 | 
| 59 | 19 django/contrib/admin/options.py | 2012 | 2068| 480 | 18623 | 65177 | 
| 60 | 19 django/contrib/admin/checks.py | 794 | 815| 190 | 18813 | 65177 | 
| 61 | 19 django/contrib/admin/options.py | 1976 | 2009| 345 | 19158 | 65177 | 
| 62 | 19 django/contrib/admin/sites.py | 83 | 97| 129 | 19287 | 65177 | 
| 63 | 19 django/contrib/admin/options.py | 2105 | 2157| 451 | 19738 | 65177 | 
| 64 | 19 django/contrib/admin/options.py | 2159 | 2184| 250 | 19988 | 65177 | 
| 65 | 19 django/contrib/admin/options.py | 219 | 241| 230 | 20218 | 65177 | 
| 66 | 19 django/contrib/admin/checks.py | 220 | 230| 127 | 20345 | 65177 | 
| 67 | 20 django/shortcuts.py | 102 | 141| 280 | 20625 | 66274 | 
| 68 | 21 django/contrib/admin/__init__.py | 1 | 25| 255 | 20880 | 66529 | 
| 69 | 21 django/contrib/admin/sites.py | 435 | 502| 482 | 21362 | 66529 | 
| 70 | 21 django/contrib/admin/options.py | 602 | 615| 122 | 21484 | 66529 | 
| 71 | 21 django/contrib/admin/checks.py | 232 | 253| 208 | 21692 | 66529 | 
| 72 | 21 django/contrib/admindocs/views.py | 140 | 158| 187 | 21879 | 66529 | 
| 73 | 21 django/contrib/admin/utils.py | 370 | 409| 350 | 22229 | 66529 | 
| 74 | 21 django/contrib/admin/models.py | 1 | 20| 118 | 22347 | 66529 | 
| 75 | 21 django/contrib/admin/options.py | 1262 | 1335| 659 | 23006 | 66529 | 
| 76 | 21 django/contrib/admin/utils.py | 412 | 441| 203 | 23209 | 66529 | 
| 77 | 21 django/contrib/admin/widgets.py | 120 | 159| 325 | 23534 | 66529 | 
| 78 | 22 django/contrib/auth/views.py | 1 | 37| 284 | 23818 | 69259 | 
| 79 | 22 django/contrib/admin/views/main.py | 1 | 44| 317 | 24135 | 69259 | 
| 80 | 22 django/contrib/admin/checks.py | 646 | 665| 183 | 24318 | 69259 | 
| 81 | 22 django/contrib/auth/admin.py | 128 | 190| 476 | 24794 | 69259 | 
| 82 | 22 django/contrib/admin/checks.py | 1043 | 1070| 194 | 24988 | 69259 | 
| 83 | 22 django/contrib/admindocs/views.py | 323 | 352| 203 | 25191 | 69259 | 
| 84 | 22 django/contrib/admin/options.py | 1364 | 1429| 581 | 25772 | 69259 | 
| 85 | 23 django/contrib/admin/templatetags/admin_list.py | 1 | 26| 186 | 25958 | 72951 | 
| 86 | 24 django/contrib/contenttypes/admin.py | 81 | 128| 410 | 26368 | 73932 | 
| 87 | 24 django/contrib/admin/options.py | 533 | 547| 169 | 26537 | 73932 | 
| 88 | 25 django/contrib/redirects/models.py | 1 | 33| 230 | 26767 | 74162 | 
| 89 | 25 django/contrib/admin/checks.py | 350 | 376| 221 | 26988 | 74162 | 
| 90 | 26 django/db/models/fields/__init__.py | 2281 | 2301| 163 | 27151 | 92309 | 
| 91 | 26 django/contrib/admin/checks.py | 146 | 163| 155 | 27306 | 92309 | 
| 92 | 27 django/contrib/sites/models.py | 25 | 46| 192 | 27498 | 93097 | 
| 93 | 27 django/contrib/admin/sites.py | 201 | 223| 167 | 27665 | 93097 | 
| 94 | 27 django/contrib/admin/sites.py | 504 | 537| 229 | 27894 | 93097 | 
| 95 | 28 django/contrib/admindocs/utils.py | 1 | 28| 184 | 28078 | 95035 | 
| 96 | 28 django/contrib/admin/options.py | 954 | 992| 269 | 28347 | 95035 | 
| 97 | 29 django/db/models/options.py | 712 | 747| 388 | 28735 | 102402 | 
| 98 | 29 django/contrib/admindocs/views.py | 119 | 137| 168 | 28903 | 102402 | 
| 99 | 29 django/db/models/options.py | 1 | 35| 300 | 29203 | 102402 | 
| 100 | 29 django/db/models/options.py | 64 | 146| 668 | 29871 | 102402 | 
| 101 | 30 django/contrib/gis/admin/options.py | 115 | 171| 563 | 30434 | 103869 | 
| 102 | 31 django/contrib/redirects/migrations/0002_alter_redirect_new_path_help_text.py | 1 | 25| 117 | 30551 | 103986 | 
| 103 | 31 django/contrib/admin/checks.py | 777 | 792| 182 | 30733 | 103986 | 
| **-> 104 <-** | **31 django/contrib/admin/helpers.py** | 160 | 215| 473 | 31206 | 103986 | 
| 105 | 31 django/contrib/admin/utils.py | 123 | 158| 303 | 31509 | 103986 | 
| 106 | 32 django/contrib/contenttypes/fields.py | 416 | 431| 124 | 31633 | 109444 | 
| 107 | 32 django/contrib/admin/options.py | 1185 | 1260| 664 | 32297 | 109444 | 
| 108 | 32 django/urls/base.py | 1 | 24| 170 | 32467 | 109444 | 
| 109 | 33 django/contrib/admin/filters.py | 1 | 17| 127 | 32594 | 113574 | 
| 110 | 34 django/contrib/gis/admin/__init__.py | 1 | 17| 162 | 32756 | 113736 | 
| 111 | 34 django/contrib/admin/checks.py | 177 | 218| 325 | 33081 | 113736 | 
| 112 | 34 django/contrib/admin/sites.py | 385 | 417| 291 | 33372 | 113736 | 
| 113 | 34 django/contrib/admin/views/main.py | 224 | 273| 420 | 33792 | 113736 | 
| 114 | 34 django/contrib/admin/templatetags/admin_list.py | 166 | 180| 136 | 33928 | 113736 | 
| 115 | 34 django/urls/resolvers.py | 641 | 651| 120 | 34048 | 113736 | 
| 116 | 34 django/contrib/admin/options.py | 514 | 531| 200 | 34248 | 113736 | 
| 117 | 34 django/db/models/fields/reverse_related.py | 160 | 178| 167 | 34415 | 113736 | 
| 118 | 34 django/contrib/admin/sites.py | 301 | 323| 187 | 34602 | 113736 | 
| 119 | 34 django/contrib/admin/options.py | 723 | 757| 251 | 34853 | 113736 | 
| 120 | 34 django/db/models/options.py | 640 | 658| 178 | 35031 | 113736 | 
| 121 | 35 django/db/models/fields/related_descriptors.py | 344 | 363| 156 | 35187 | 124125 | 
| 122 | 35 django/contrib/admin/options.py | 1048 | 1070| 198 | 35385 | 124125 | 
| 123 | 36 django/db/models/fields/related.py | 139 | 166| 201 | 35586 | 138095 | 
| 124 | 36 django/contrib/admin/options.py | 550 | 600| 350 | 35936 | 138095 | 
| 125 | 36 django/db/models/fields/related.py | 1262 | 1379| 963 | 36899 | 138095 | 
| 126 | 36 django/db/models/fields/related.py | 913 | 932| 145 | 37044 | 138095 | 
| 127 | 36 django/contrib/contenttypes/admin.py | 1 | 78| 571 | 37615 | 138095 | 
| 128 | 36 django/contrib/admin/checks.py | 1029 | 1041| 116 | 37731 | 138095 | 
| 129 | 36 django/contrib/admin/filters.py | 162 | 207| 427 | 38158 | 138095 | 
| 130 | 36 django/db/models/fields/related.py | 728 | 766| 335 | 38493 | 138095 | 
| 131 | 37 django/views/generic/base.py | 191 | 222| 247 | 38740 | 139745 | 
| 132 | 38 django/contrib/redirects/apps.py | 1 | 9| 0 | 38740 | 139796 | 
| 133 | 38 django/db/models/fields/related.py | 885 | 911| 240 | 38980 | 139796 | 
| 134 | 39 django/db/models/base.py | 2127 | 2178| 351 | 39331 | 157126 | 
| 135 | 39 django/contrib/admin/options.py | 927 | 952| 216 | 39547 | 157126 | 
| 136 | 39 django/contrib/admin/options.py | 904 | 925| 221 | 39768 | 157126 | 
| 137 | **39 django/contrib/admin/helpers.py** | 1 | 32| 215 | 39983 | 157126 | 
| 138 | 39 django/contrib/admin/checks.py | 546 | 569| 230 | 40213 | 157126 | 
| 139 | 39 django/urls/resolvers.py | 429 | 445| 164 | 40377 | 157126 | 
| 140 | 39 django/contrib/admin/sites.py | 325 | 340| 158 | 40535 | 157126 | 
| 141 | 39 django/contrib/auth/admin.py | 101 | 126| 286 | 40821 | 157126 | 
| 142 | 39 django/contrib/sites/models.py | 48 | 75| 236 | 41057 | 157126 | 
| 143 | 39 django/contrib/admin/checks.py | 696 | 730| 265 | 41322 | 157126 | 
| 144 | **39 django/contrib/admin/helpers.py** | 277 | 300| 235 | 41557 | 157126 | 
| 145 | 39 django/contrib/admin/options.py | 659 | 673| 136 | 41693 | 157126 | 
| 146 | 40 django/db/backends/sqlite3/schema.py | 142 | 223| 820 | 42513 | 161329 | 
| 147 | 41 django/views/defaults.py | 1 | 24| 149 | 42662 | 162357 | 
| 148 | 42 django/contrib/flatpages/models.py | 1 | 48| 363 | 43025 | 162720 | 
| 149 | 42 django/db/models/fields/related.py | 934 | 954| 178 | 43203 | 162720 | 
| 150 | 42 django/db/models/fields/related.py | 198 | 264| 674 | 43877 | 162720 | 
| 151 | 43 django/db/migrations/operations/models.py | 370 | 390| 213 | 44090 | 169170 | 
| 152 | 43 django/contrib/admin/options.py | 1678 | 1692| 132 | 44222 | 169170 | 
| 153 | 43 django/contrib/admindocs/utils.py | 89 | 115| 175 | 44397 | 169170 | 
| 154 | 44 django/views/csrf.py | 15 | 100| 835 | 45232 | 170714 | 
| 155 | 44 django/contrib/admin/options.py | 499 | 512| 165 | 45397 | 170714 | 
| 156 | 44 django/contrib/admin/checks.py | 449 | 470| 191 | 45588 | 170714 | 
| 157 | 44 django/db/models/fields/related.py | 971 | 1003| 279 | 45867 | 170714 | 
| 158 | 44 django/contrib/admin/checks.py | 744 | 775| 219 | 46086 | 170714 | 
| 159 | 44 django/contrib/admin/options.py | 1431 | 1470| 309 | 46395 | 170714 | 
| 160 | 45 django/conf/urls/__init__.py | 1 | 10| 0 | 46395 | 170779 | 
| 161 | 46 django/contrib/auth/migrations/0011_update_proxy_permissions.py | 1 | 51| 444 | 46839 | 171332 | 
| 162 | 46 django/contrib/admin/utils.py | 310 | 367| 466 | 47305 | 171332 | 
| 163 | **46 django/contrib/admin/helpers.py** | 389 | 398| 134 | 47439 | 171332 | 
| 164 | 46 django/contrib/admin/views/main.py | 131 | 222| 851 | 48290 | 171332 | 
| 165 | 46 django/contrib/admin/sites.py | 147 | 199| 349 | 48639 | 171332 | 
| 166 | 46 django/contrib/auth/admin.py | 25 | 37| 128 | 48767 | 171332 | 
| 167 | 47 django/contrib/admin/exceptions.py | 1 | 12| 0 | 48767 | 171399 | 
| 168 | 47 django/db/models/options.py | 587 | 610| 228 | 48995 | 171399 | 
| 169 | 47 django/db/models/fields/related.py | 956 | 969| 126 | 49121 | 171399 | 
| 170 | 47 django/contrib/admin/options.py | 774 | 785| 114 | 49235 | 171399 | 
| 171 | 47 django/contrib/admin/utils.py | 1 | 25| 231 | 49466 | 171399 | 
| 172 | 47 django/contrib/admin/views/main.py | 47 | 129| 718 | 50184 | 171399 | 
| 173 | 48 django/contrib/auth/checks.py | 105 | 211| 776 | 50960 | 172897 | 
| 174 | 49 django/contrib/admindocs/apps.py | 1 | 8| 0 | 50960 | 172939 | 
| 175 | 49 django/db/migrations/operations/models.py | 319 | 368| 493 | 51453 | 172939 | 
| 176 | 49 django/contrib/admindocs/views.py | 34 | 54| 159 | 51612 | 172939 | 
| 177 | 49 django/db/models/fields/related.py | 594 | 627| 334 | 51946 | 172939 | 
| 178 | 49 django/db/models/options.py | 365 | 388| 198 | 52144 | 172939 | 
| 179 | 50 django/contrib/redirects/migrations/0001_initial.py | 1 | 40| 268 | 52412 | 173207 | 
| 180 | **50 django/contrib/admin/helpers.py** | 131 | 157| 220 | 52632 | 173207 | 
| 181 | 50 django/contrib/auth/migrations/0011_update_proxy_permissions.py | 54 | 70| 109 | 52741 | 173207 | 
| 182 | 51 django/middleware/common.py | 34 | 61| 257 | 52998 | 174736 | 
| 183 | 52 django/db/migrations/autodetector.py | 804 | 854| 576 | 53574 | 186324 | 
| 184 | 53 django/contrib/redirects/middleware.py | 1 | 51| 354 | 53928 | 186679 | 
| 185 | 54 django/db/migrations/state.py | 1 | 29| 230 | 54158 | 194542 | 
| 186 | 55 django/contrib/admin/views/autocomplete.py | 56 | 111| 421 | 54579 | 195363 | 
| 187 | 55 django/shortcuts.py | 23 | 54| 243 | 54822 | 195363 | 
| 188 | 55 django/contrib/gis/admin/options.py | 87 | 98| 139 | 54961 | 195363 | 
| 189 | 56 django/contrib/flatpages/urls.py | 1 | 7| 0 | 54961 | 195401 | 
| 190 | 57 docs/_ext/djangodocs.py | 26 | 71| 398 | 55359 | 198557 | 
| 191 | 57 django/contrib/admin/checks.py | 1011 | 1026| 136 | 55495 | 198557 | 
| 192 | 57 django/contrib/admin/widgets.py | 273 | 308| 382 | 55877 | 198557 | 


### Hint

```
Hey Ken, yes seems right. Good spot. Looks like this should have been part of b79088306513d5ed76d31ac40ab3c15f858946ea for #31181 (which was Django 3.2) â€‹here. However, I don't know if there are any side effects and I have not yet run the full suite of tests on this. Mostly looking for feedback whether I'm on the right track. I ran your suggestion against most of the usual suspects admin_* tests without issue so... Would you like to prepare a patch? Looks like setting up the test case is the most of it... Thanks!
I'll be happy to try - but I'm not likely to be able to get to it before the weekend. (I don't know how "urgent" you consider it.) If it can sit that long, I'll see what I can do. (First "real patch" and all that - want to make sure I do it reasonably right.)
Hey Ken. Super thanks! Since it's a bug in a new feature it's marked as release blocker and will be backported to Django 3.2. We'll target â€‹3.2.8, which is slated for the beginning of October. If it gets close to that and you've not had time we can pick it up. Reach out on the Forum if you'd like input at all. ðŸ™‚ Thanks! (And Welcome Aboard! â›µï¸)
Heyy folks, I wanted to assign the ticket to myself and fix the issue, instead it assigned the ownership to me. Apologies
Changes ownership again.
I found out that changes got accepted, sorry for the inconvenience caused.
Hi Abhijith â€” just to confirm, according to the discussion Ken is currently working on this ticket, so let's give him a window to do that before re-assigning it. Thanks! (I think that's the conclusion you came to, but just double-checking so you don't both work on the same ticket at the same time.)
```

## Patch

```diff
diff --git a/django/contrib/admin/helpers.py b/django/contrib/admin/helpers.py
--- a/django/contrib/admin/helpers.py
+++ b/django/contrib/admin/helpers.py
@@ -209,7 +209,11 @@ def get_admin_url(self, remote_field, remote_obj):
             remote_field.model._meta.model_name,
         )
         try:
-            url = reverse(url_name, args=[quote(remote_obj.pk)])
+            url = reverse(
+                url_name,
+                args=[quote(remote_obj.pk)],
+                current_app=self.model_admin.admin_site.name,
+            )
             return format_html('<a href="{}">{}</a>', url, remote_obj)
         except NoReverseMatch:
             return str(remote_obj)

```

## Test Patch

```diff
diff --git a/tests/admin_views/admin.py b/tests/admin_views/admin.py
--- a/tests/admin_views/admin.py
+++ b/tests/admin_views/admin.py
@@ -1142,6 +1142,8 @@ def get_formsets_with_inlines(self, request, obj=None):
     raw_id_fields=['parent'],
 )
 site2.register(Person, save_as_continue=False)
+site2.register(ReadOnlyRelatedField, ReadOnlyRelatedFieldAdmin)
+site2.register(Language)
 
 site7 = admin.AdminSite(name="admin7")
 site7.register(Article, ArticleAdmin2)
diff --git a/tests/admin_views/tests.py b/tests/admin_views/tests.py
--- a/tests/admin_views/tests.py
+++ b/tests/admin_views/tests.py
@@ -5093,7 +5093,7 @@ def test_change_form_renders_correct_null_choice_value(self):
         response = self.client.get(reverse('admin:admin_views_choice_change', args=(choice.pk,)))
         self.assertContains(response, '<div class="readonly">No opinion</div>', html=True)
 
-    def test_readonly_foreignkey_links(self):
+    def _test_readonly_foreignkey_links(self, admin_site):
         """
         ForeignKey readonly fields render as links if the target model is
         registered in admin.
@@ -5110,10 +5110,10 @@ def test_readonly_foreignkey_links(self):
             user=self.superuser,
         )
         response = self.client.get(
-            reverse('admin:admin_views_readonlyrelatedfield_change', args=(obj.pk,)),
+            reverse(f'{admin_site}:admin_views_readonlyrelatedfield_change', args=(obj.pk,)),
         )
         # Related ForeignKey object registered in admin.
-        user_url = reverse('admin:auth_user_change', args=(self.superuser.pk,))
+        user_url = reverse(f'{admin_site}:auth_user_change', args=(self.superuser.pk,))
         self.assertContains(
             response,
             '<div class="readonly"><a href="%s">super</a></div>' % user_url,
@@ -5121,7 +5121,7 @@ def test_readonly_foreignkey_links(self):
         )
         # Related ForeignKey with the string primary key registered in admin.
         language_url = reverse(
-            'admin:admin_views_language_change',
+            f'{admin_site}:admin_views_language_change',
             args=(quote(language.pk),),
         )
         self.assertContains(
@@ -5132,6 +5132,12 @@ def test_readonly_foreignkey_links(self):
         # Related ForeignKey object not registered in admin.
         self.assertContains(response, '<div class="readonly">Chapter 1</div>', html=True)
 
+    def test_readonly_foreignkey_links_default_admin_site(self):
+        self._test_readonly_foreignkey_links('admin')
+
+    def test_readonly_foreignkey_links_custom_admin_site(self):
+        self._test_readonly_foreignkey_links('namespaced_admin')
+
     def test_readonly_manytomany_backwards_ref(self):
         """
         Regression test for #16433 - backwards references for related objects

```


## Code snippets

### 1 - django/contrib/admin/options.py:

Start line: 617, End line: 638

```python
class ModelAdmin(BaseModelAdmin):

    def get_urls(self):
        from django.urls import path

        def wrap(view):
            def wrapper(*args, **kwargs):
                return self.admin_site.admin_view(view)(*args, **kwargs)
            wrapper.model_admin = self
            return update_wrapper(wrapper, view)

        info = self.model._meta.app_label, self.model._meta.model_name

        return [
            path('', wrap(self.changelist_view), name='%s_%s_changelist' % info),
            path('add/', wrap(self.add_view), name='%s_%s_add' % info),
            path('<path:object_id>/history/', wrap(self.history_view), name='%s_%s_history' % info),
            path('<path:object_id>/delete/', wrap(self.delete_view), name='%s_%s_delete' % info),
            path('<path:object_id>/change/', wrap(self.change_view), name='%s_%s_change' % info),
            # For backwards compatibility (was the change url before 1.9)
            path('<path:object_id>/', wrap(RedirectView.as_view(
                pattern_name='%s:%s_%s_change' % ((self.admin_site.name,) + info)
            ))),
        ]
```
### 2 - django/contrib/admin/sites.py:

Start line: 245, End line: 299

```python
class AdminSite:

    def get_urls(self):
        # Since this module gets imported in the application's root package,
        # it cannot import models from other applications at the module level,
        # and django.contrib.contenttypes.views imports ContentType.
        from django.contrib.contenttypes import views as contenttype_views
        from django.urls import include, path, re_path

        def wrap(view, cacheable=False):
            def wrapper(*args, **kwargs):
                return self.admin_view(view, cacheable)(*args, **kwargs)
            wrapper.admin_site = self
            return update_wrapper(wrapper, view)

        # Admin-site-wide views.
        urlpatterns = [
            path('', wrap(self.index), name='index'),
            path('login/', self.login, name='login'),
            path('logout/', wrap(self.logout), name='logout'),
            path('password_change/', wrap(self.password_change, cacheable=True), name='password_change'),
            path(
                'password_change/done/',
                wrap(self.password_change_done, cacheable=True),
                name='password_change_done',
            ),
            path('autocomplete/', wrap(self.autocomplete_view), name='autocomplete'),
            path('jsi18n/', wrap(self.i18n_javascript, cacheable=True), name='jsi18n'),
            path(
                'r/<int:content_type_id>/<path:object_id>/',
                wrap(contenttype_views.shortcut),
                name='view_on_site',
            ),
        ]

        # Add in each model's views, and create a list of valid URLS for the
        # app_index
        valid_app_labels = []
        for model, model_admin in self._registry.items():
            urlpatterns += [
                path('%s/%s/' % (model._meta.app_label, model._meta.model_name), include(model_admin.urls)),
            ]
            if model._meta.app_label not in valid_app_labels:
                valid_app_labels.append(model._meta.app_label)

        # If there were ModelAdmins registered, we should have a list of app
        # labels for which we need to allow access to the app_index view,
        if valid_app_labels:
            regex = r'^(?P<app_label>' + '|'.join(valid_app_labels) + ')/$'
            urlpatterns += [
                re_path(regex, wrap(self.app_index), name='app_list'),
            ]

        if self.final_catch_all_view:
            urlpatterns.append(re_path(r'(?P<url>.*)$', wrap(self.catch_all_view)))

        return urlpatterns
```
### 3 - django/contrib/admin/sites.py:

Start line: 224, End line: 243

```python
class AdminSite:

    def admin_view(self, view, cacheable=False):
        def inner(request, *args, **kwargs):
            if not self.has_permission(request):
                if request.path == reverse('admin:logout', current_app=self.name):
                    index_path = reverse('admin:index', current_app=self.name)
                    return HttpResponseRedirect(index_path)
                # Inner import to prevent django.contrib.admin (app) from
                # importing django.contrib.auth.models.User (unrelated model).
                from django.contrib.auth.views import redirect_to_login
                return redirect_to_login(
                    request.get_full_path(),
                    reverse('admin:login', current_app=self.name)
                )
            return view(request, *args, **kwargs)
        if not cacheable:
            inner = never_cache(inner)
        # We add csrf_protect here so this function can be used as a utility
        # function for any view, without having to repeat 'csrf_protect'.
        if not getattr(view, 'csrf_exempt', False):
            inner = csrf_protect(inner)
        return update_wrapper(inner, view)
```
### 4 - django/contrib/admin/widgets.py:

Start line: 161, End line: 192

```python
class ForeignKeyRawIdWidget(forms.TextInput):

    def base_url_parameters(self):
        limit_choices_to = self.rel.limit_choices_to
        if callable(limit_choices_to):
            limit_choices_to = limit_choices_to()
        return url_params_from_lookup_dict(limit_choices_to)

    def url_parameters(self):
        from django.contrib.admin.views.main import TO_FIELD_VAR
        params = self.base_url_parameters()
        params.update({TO_FIELD_VAR: self.rel.get_related_field().name})
        return params

    def label_and_url_for_value(self, value):
        key = self.rel.get_related_field().name
        try:
            obj = self.rel.model._default_manager.using(self.db).get(**{key: value})
        except (ValueError, self.rel.model.DoesNotExist, ValidationError):
            return '', ''

        try:
            url = reverse(
                '%s:%s_%s_change' % (
                    self.admin_site.name,
                    obj._meta.app_label,
                    obj._meta.object_name.lower(),
                ),
                args=(obj.pk,)
            )
        except NoReverseMatch:
            url = ''  # Admin not registered for target model.

        return Truncator(obj).words(14), url
```
### 5 - django/contrib/admin/options.py:

Start line: 1551, End line: 1637

```python
class ModelAdmin(BaseModelAdmin):

    def _changeform_view(self, request, object_id, form_url, extra_context):
        to_field = request.POST.get(TO_FIELD_VAR, request.GET.get(TO_FIELD_VAR))
        if to_field and not self.to_field_allowed(request, to_field):
            raise DisallowedModelAdminToField("The field %s cannot be referenced." % to_field)

        model = self.model
        opts = model._meta

        if request.method == 'POST' and '_saveasnew' in request.POST:
            object_id = None

        add = object_id is None

        if add:
            if not self.has_add_permission(request):
                raise PermissionDenied
            obj = None

        else:
            obj = self.get_object(request, unquote(object_id), to_field)

            if request.method == 'POST':
                if not self.has_change_permission(request, obj):
                    raise PermissionDenied
            else:
                if not self.has_view_or_change_permission(request, obj):
                    raise PermissionDenied

            if obj is None:
                return self._get_obj_does_not_exist_redirect(request, opts, object_id)

        fieldsets = self.get_fieldsets(request, obj)
        ModelForm = self.get_form(
            request, obj, change=not add, fields=flatten_fieldsets(fieldsets)
        )
        if request.method == 'POST':
            form = ModelForm(request.POST, request.FILES, instance=obj)
            form_validated = form.is_valid()
            if form_validated:
                new_object = self.save_form(request, form, change=not add)
            else:
                new_object = form.instance
            formsets, inline_instances = self._create_formsets(request, new_object, change=not add)
            if all_valid(formsets) and form_validated:
                self.save_model(request, new_object, form, not add)
                self.save_related(request, form, formsets, not add)
                change_message = self.construct_change_message(request, form, formsets, add)
                if add:
                    self.log_addition(request, new_object, change_message)
                    return self.response_add(request, new_object)
                else:
                    self.log_change(request, new_object, change_message)
                    return self.response_change(request, new_object)
            else:
                form_validated = False
        else:
            if add:
                initial = self.get_changeform_initial_data(request)
                form = ModelForm(initial=initial)
                formsets, inline_instances = self._create_formsets(request, form.instance, change=False)
            else:
                form = ModelForm(instance=obj)
                formsets, inline_instances = self._create_formsets(request, obj, change=True)

        if not add and not self.has_change_permission(request, obj):
            readonly_fields = flatten_fieldsets(fieldsets)
        else:
            readonly_fields = self.get_readonly_fields(request, obj)
        adminForm = helpers.AdminForm(
            form,
            list(fieldsets),
            # Clear prepopulated fields on a view-only form to avoid a crash.
            self.get_prepopulated_fields(request, obj) if add or self.has_change_permission(request, obj) else {},
            readonly_fields,
            model_admin=self)
        media = self.media + adminForm.media

        inline_formsets = self.get_inline_formsets(request, formsets, inline_instances, obj)
        for inline_formset in inline_formsets:
            media = media + inline_formset.media

        if add:
            title = _('Add %s')
        elif self.has_change_permission(request, obj):
            title = _('Change %s')
        else:
            title = _('View %s')
        # ... other code
```
### 6 - django/contrib/admin/options.py:

Start line: 1638, End line: 1663

```python
class ModelAdmin(BaseModelAdmin):

    def _changeform_view(self, request, object_id, form_url, extra_context):
        # ... other code
        context = {
            **self.admin_site.each_context(request),
            'title': title % opts.verbose_name,
            'subtitle': str(obj) if obj else None,
            'adminform': adminForm,
            'object_id': object_id,
            'original': obj,
            'is_popup': IS_POPUP_VAR in request.POST or IS_POPUP_VAR in request.GET,
            'to_field': to_field,
            'media': media,
            'inline_admin_formsets': inline_formsets,
            'errors': helpers.AdminErrorList(form, formsets),
            'preserved_filters': self.get_preserved_filters(request),
        }

        # Hide the "Save" and "Save and continue" buttons if "Save as New" was
        # previously chosen to prevent the interface from getting confusing.
        if request.method == 'POST' and not form_validated and "_saveasnew" in request.POST:
            context['show_save'] = False
            context['show_save_and_continue'] = False
            # Use the change template instead of the add template.
            add = False

        context.update(extra_context or {})

        return self.render_change_form(request, context, add=add, change=not add, obj=obj, form_url=form_url)
```
### 7 - django/contrib/admin/options.py:

Start line: 1, End line: 96

```python
import copy
import json
import re
from functools import partial, update_wrapper
from urllib.parse import quote as urlquote

from django import forms
from django.conf import settings
from django.contrib import messages
from django.contrib.admin import helpers, widgets
from django.contrib.admin.checks import (
    BaseModelAdminChecks, InlineModelAdminChecks, ModelAdminChecks,
)
from django.contrib.admin.decorators import display
from django.contrib.admin.exceptions import DisallowedModelAdminToField
from django.contrib.admin.templatetags.admin_urls import add_preserved_filters
from django.contrib.admin.utils import (
    NestedObjects, construct_change_message, flatten_fieldsets,
    get_deleted_objects, lookup_spawns_duplicates, model_format_dict,
    model_ngettext, quote, unquote,
)
from django.contrib.admin.widgets import (
    AutocompleteSelect, AutocompleteSelectMultiple,
)
from django.contrib.auth import get_permission_codename
from django.core.exceptions import (
    FieldDoesNotExist, FieldError, PermissionDenied, ValidationError,
)
from django.core.paginator import Paginator
from django.db import models, router, transaction
from django.db.models.constants import LOOKUP_SEP
from django.forms.formsets import DELETION_FIELD_NAME, all_valid
from django.forms.models import (
    BaseInlineFormSet, inlineformset_factory, modelform_defines_fields,
    modelform_factory, modelformset_factory,
)
from django.forms.widgets import CheckboxSelectMultiple, SelectMultiple
from django.http import HttpResponseRedirect
from django.http.response import HttpResponseBase
from django.template.response import SimpleTemplateResponse, TemplateResponse
from django.urls import reverse
from django.utils.decorators import method_decorator
from django.utils.html import format_html
from django.utils.http import urlencode
from django.utils.safestring import mark_safe
from django.utils.text import (
    capfirst, format_lazy, get_text_list, smart_split, unescape_string_literal,
)
from django.utils.translation import gettext as _, ngettext
from django.views.decorators.csrf import csrf_protect
from django.views.generic import RedirectView

IS_POPUP_VAR = '_popup'
TO_FIELD_VAR = '_to_field'


HORIZONTAL, VERTICAL = 1, 2


def get_content_type_for_model(obj):
    # Since this module gets imported in the application's root package,
    # it cannot import models from other applications at the module level.
    from django.contrib.contenttypes.models import ContentType
    return ContentType.objects.get_for_model(obj, for_concrete_model=False)


def get_ul_class(radio_style):
    return 'radiolist' if radio_style == VERTICAL else 'radiolist inline'


class IncorrectLookupParameters(Exception):
    pass


# Defaults for formfield_overrides. ModelAdmin subclasses can change this
# by adding to ModelAdmin.formfield_overrides.

FORMFIELD_FOR_DBFIELD_DEFAULTS = {
    models.DateTimeField: {
        'form_class': forms.SplitDateTimeField,
        'widget': widgets.AdminSplitDateTime
    },
    models.DateField: {'widget': widgets.AdminDateWidget},
    models.TimeField: {'widget': widgets.AdminTimeWidget},
    models.TextField: {'widget': widgets.AdminTextareaWidget},
    models.URLField: {'widget': widgets.AdminURLFieldWidget},
    models.IntegerField: {'widget': widgets.AdminIntegerFieldWidget},
    models.BigIntegerField: {'widget': widgets.AdminBigIntegerFieldWidget},
    models.CharField: {'widget': widgets.AdminTextInputWidget},
    models.ImageField: {'widget': widgets.AdminFileWidget},
    models.FileField: {'widget': widgets.AdminFileWidget},
    models.EmailField: {'widget': widgets.AdminEmailInputWidget},
    models.UUIDField: {'widget': widgets.AdminUUIDInputWidget},
}

csrf_protect_m = method_decorator(csrf_protect)
```
### 8 - django/contrib/admin/options.py:

Start line: 1337, End line: 1362

```python
class ModelAdmin(BaseModelAdmin):

    def _response_post_save(self, request, obj):
        opts = self.model._meta
        if self.has_view_or_change_permission(request):
            post_url = reverse('admin:%s_%s_changelist' %
                               (opts.app_label, opts.model_name),
                               current_app=self.admin_site.name)
            preserved_filters = self.get_preserved_filters(request)
            post_url = add_preserved_filters({'preserved_filters': preserved_filters, 'opts': opts}, post_url)
        else:
            post_url = reverse('admin:index',
                               current_app=self.admin_site.name)
        return HttpResponseRedirect(post_url)

    def response_post_save_add(self, request, obj):
        """
        Figure out where to redirect after the 'Save' button has been pressed
        when adding a new object.
        """
        return self._response_post_save(request, obj)

    def response_post_save_change(self, request, obj):
        """
        Figure out where to redirect after the 'Save' button has been pressed
        when editing an existing object.
        """
        return self._response_post_save(request, obj)
```
### 9 - django/contrib/admin/sites.py:

Start line: 539, End line: 559

```python
class AdminSite:

    def app_index(self, request, app_label, extra_context=None):
        app_dict = self._build_app_dict(request, app_label)
        if not app_dict:
            raise Http404('The requested admin page does not exist.')
        # Sort the models alphabetically within each app.
        app_dict['models'].sort(key=lambda x: x['name'])
        context = {
            **self.each_context(request),
            'title': _('%(app)s administration') % {'app': app_dict['name']},
            'subtitle': None,
            'app_list': [app_dict],
            'app_label': app_label,
            **(extra_context or {}),
        }

        request.current_app = self.name

        return TemplateResponse(request, self.app_index_template or [
            'admin/%s/app_index.html' % app_label,
            'admin/app_index.html'
        ], context)
```
### 10 - django/contrib/admin/checks.py:

Start line: 608, End line: 619

```python
class BaseModelAdminChecks:

    def _check_readonly_fields(self, obj):
        """ Check that readonly_fields refers to proper attribute or field. """

        if obj.readonly_fields == ():
            return []
        elif not isinstance(obj.readonly_fields, (list, tuple)):
            return must_be('a list or tuple', option='readonly_fields', obj=obj, id='admin.E034')
        else:
            return list(chain.from_iterable(
                self._check_readonly_fields_item(obj, field_name, "readonly_fields[%d]" % index)
                for index, field_name in enumerate(obj.readonly_fields)
            ))
```
### 19 - django/contrib/admin/helpers.py:

Start line: 217, End line: 250

```python
class AdminReadonlyField:

    def contents(self):
        from django.contrib.admin.templatetags.admin_list import _boolean_icon
        field, obj, model_admin = self.field['field'], self.form.instance, self.model_admin
        try:
            f, attr, value = lookup_field(field, obj, model_admin)
        except (AttributeError, ValueError, ObjectDoesNotExist):
            result_repr = self.empty_value_display
        else:
            if field in self.form.fields:
                widget = self.form[field].field.widget
                # This isn't elegant but suffices for contrib.auth's
                # ReadOnlyPasswordHashWidget.
                if getattr(widget, 'read_only', False):
                    return widget.render(field, value)
            if f is None:
                if getattr(attr, 'boolean', False):
                    result_repr = _boolean_icon(value)
                else:
                    if hasattr(value, "__html__"):
                        result_repr = value
                    else:
                        result_repr = linebreaksbr(value)
            else:
                if isinstance(f.remote_field, ManyToManyRel) and value is not None:
                    result_repr = ", ".join(map(str, value.all()))
                elif (
                    isinstance(f.remote_field, (ForeignObjectRel, OneToOneField)) and
                    value is not None
                ):
                    result_repr = self.get_admin_url(f.remote_field, value)
                else:
                    result_repr = display_for_field(value, f, self.empty_value_display)
                result_repr = linebreaksbr(result_repr)
        return conditional_escape(result_repr)
```
### 37 - django/contrib/admin/helpers.py:

Start line: 35, End line: 76

```python
class AdminForm:
    def __init__(self, form, fieldsets, prepopulated_fields, readonly_fields=None, model_admin=None):
        self.form, self.fieldsets = form, fieldsets
        self.prepopulated_fields = [{
            'field': form[field_name],
            'dependencies': [form[f] for f in dependencies]
        } for field_name, dependencies in prepopulated_fields.items()]
        self.model_admin = model_admin
        if readonly_fields is None:
            readonly_fields = ()
        self.readonly_fields = readonly_fields

    def __repr__(self):
        return (
            f'<{self.__class__.__qualname__}: '
            f'form={self.form.__class__.__qualname__} '
            f'fieldsets={self.fieldsets!r}>'
        )

    def __iter__(self):
        for name, options in self.fieldsets:
            yield Fieldset(
                self.form, name,
                readonly_fields=self.readonly_fields,
                model_admin=self.model_admin,
                **options
            )

    @property
    def errors(self):
        return self.form.errors

    @property
    def non_field_errors(self):
        return self.form.non_field_errors

    @property
    def media(self):
        media = self.form.media
        for fs in self:
            media = media + fs.media
        return media
```
### 53 - django/contrib/admin/helpers.py:

Start line: 100, End line: 128

```python
class Fieldline:
    def __init__(self, form, field, readonly_fields=None, model_admin=None):
        self.form = form  # A django.forms.Form instance
        if not hasattr(field, "__iter__") or isinstance(field, str):
            self.fields = [field]
        else:
            self.fields = field
        self.has_visible_field = not all(
            field in self.form.fields and self.form.fields[field].widget.is_hidden
            for field in self.fields
        )
        self.model_admin = model_admin
        if readonly_fields is None:
            readonly_fields = ()
        self.readonly_fields = readonly_fields

    def __iter__(self):
        for i, field in enumerate(self.fields):
            if field in self.readonly_fields:
                yield AdminReadonlyField(self.form, field, is_first=(i == 0), model_admin=self.model_admin)
            else:
                yield AdminField(self.form, field, is_first=(i == 0))

    def errors(self):
        return mark_safe(
            '\n'.join(
                self.form[f].errors.as_ul() for f in self.fields if f not in self.readonly_fields
            ).strip('\n')
        )
```
### 54 - django/contrib/admin/helpers.py:

Start line: 400, End line: 416

```python
class InlineAdminForm(AdminForm):

    def pk_field(self):
        return AdminField(self.form, self.formset._pk_field.name, False)

    def fk_field(self):
        fk = getattr(self.formset, "fk", None)
        if fk:
            return AdminField(self.form, fk.name, False)
        else:
            return ""

    def deletion_field(self):
        from django.forms.formsets import DELETION_FIELD_NAME
        return AdminField(self.form, DELETION_FIELD_NAME, False)

    def ordering_field(self):
        from django.forms.formsets import ORDERING_FIELD_NAME
        return AdminField(self.form, ORDERING_FIELD_NAME, False)
```
### 104 - django/contrib/admin/helpers.py:

Start line: 160, End line: 215

```python
class AdminReadonlyField:
    def __init__(self, form, field, is_first, model_admin=None):
        # Make self.field look a little bit like a field. This means that
        # {{ field.name }} must be a useful class name to identify the field.
        # For convenience, store other field-related data here too.
        if callable(field):
            class_name = field.__name__ if field.__name__ != '<lambda>' else ''
        else:
            class_name = field

        if form._meta.labels and class_name in form._meta.labels:
            label = form._meta.labels[class_name]
        else:
            label = label_for_field(field, form._meta.model, model_admin, form=form)

        if form._meta.help_texts and class_name in form._meta.help_texts:
            help_text = form._meta.help_texts[class_name]
        else:
            help_text = help_text_for_field(class_name, form._meta.model)

        if field in form.fields:
            is_hidden = form.fields[field].widget.is_hidden
        else:
            is_hidden = False

        self.field = {
            'name': class_name,
            'label': label,
            'help_text': help_text,
            'field': field,
            'is_hidden': is_hidden,
        }
        self.form = form
        self.model_admin = model_admin
        self.is_first = is_first
        self.is_checkbox = False
        self.is_readonly = True
        self.empty_value_display = model_admin.get_empty_value_display()

    def label_tag(self):
        attrs = {}
        if not self.is_first:
            attrs["class"] = "inline"
        label = self.field['label']
        return format_html('<label{}>{}{}</label>', flatatt(attrs), capfirst(label), self.form.label_suffix)

    def get_admin_url(self, remote_field, remote_obj):
        url_name = 'admin:%s_%s_change' % (
            remote_field.model._meta.app_label,
            remote_field.model._meta.model_name,
        )
        try:
            url = reverse(url_name, args=[quote(remote_obj.pk)])
            return format_html('<a href="{}">{}</a>', url, remote_obj)
        except NoReverseMatch:
            return str(remote_obj)
```
### 137 - django/contrib/admin/helpers.py:

Start line: 1, End line: 32

```python
import json

from django import forms
from django.contrib.admin.utils import (
    display_for_field, flatten_fieldsets, help_text_for_field, label_for_field,
    lookup_field, quote,
)
from django.core.exceptions import ObjectDoesNotExist
from django.db.models.fields.related import (
    ForeignObjectRel, ManyToManyRel, OneToOneField,
)
from django.forms.utils import flatatt
from django.template.defaultfilters import capfirst, linebreaksbr
from django.urls import NoReverseMatch, reverse
from django.utils.html import conditional_escape, format_html
from django.utils.safestring import mark_safe
from django.utils.translation import gettext, gettext_lazy as _

ACTION_CHECKBOX_NAME = '_selected_action'


class ActionForm(forms.Form):
    action = forms.ChoiceField(label=_('Action:'))
    select_across = forms.BooleanField(
        label='',
        required=False,
        initial=0,
        widget=forms.HiddenInput({'class': 'select-across'}),
    )


checkbox = forms.CheckboxInput({'class': 'action-select'}, lambda value: False)
```
### 144 - django/contrib/admin/helpers.py:

Start line: 277, End line: 300

```python
class InlineAdminFormSet:

    def __iter__(self):
        if self.has_change_permission:
            readonly_fields_for_editing = self.readonly_fields
        else:
            readonly_fields_for_editing = self.readonly_fields + flatten_fieldsets(self.fieldsets)

        for form, original in zip(self.formset.initial_forms, self.formset.get_queryset()):
            view_on_site_url = self.opts.get_view_on_site_url(original)
            yield InlineAdminForm(
                self.formset, form, self.fieldsets, self.prepopulated_fields,
                original, readonly_fields_for_editing, model_admin=self.opts,
                view_on_site_url=view_on_site_url,
            )
        for form in self.formset.extra_forms:
            yield InlineAdminForm(
                self.formset, form, self.fieldsets, self.prepopulated_fields,
                None, self.readonly_fields, model_admin=self.opts,
            )
        if self.has_add_permission:
            yield InlineAdminForm(
                self.formset, self.formset.empty_form,
                self.fieldsets, self.prepopulated_fields, None,
                self.readonly_fields, model_admin=self.opts,
            )
```
### 163 - django/contrib/admin/helpers.py:

Start line: 389, End line: 398

```python
class InlineAdminForm(AdminForm):

    def needs_explicit_pk_field(self):
        return (
            # Auto fields are editable, so check for auto or non-editable pk.
            self.form._meta.model._meta.auto_field or not self.form._meta.model._meta.pk.editable or
            # Also search any parents for an auto field. (The pk info is
            # propagated to child models so that does not need to be checked
            # in parents.)
            any(parent._meta.auto_field or not parent._meta.model._meta.pk.editable
                for parent in self.form._meta.model._meta.get_parent_list())
        )
```
### 180 - django/contrib/admin/helpers.py:

Start line: 131, End line: 157

```python
class AdminField:
    def __init__(self, form, field, is_first):
        self.field = form[field]  # A django.forms.BoundField instance
        self.is_first = is_first  # Whether this field is first on the line
        self.is_checkbox = isinstance(self.field.field.widget, forms.CheckboxInput)
        self.is_readonly = False

    def label_tag(self):
        classes = []
        contents = conditional_escape(self.field.label)
        if self.is_checkbox:
            classes.append('vCheckboxLabel')

        if self.field.field.required:
            classes.append('required')
        if not self.is_first:
            classes.append('inline')
        attrs = {'class': ' '.join(classes)} if classes else {}
        # checkboxes should not have a label suffix as the checkbox appears
        # to the left of the label.
        return self.field.label_tag(
            contents=mark_safe(contents), attrs=attrs,
            label_suffix='' if self.is_checkbox else None,
        )

    def errors(self):
        return mark_safe(self.field.errors.as_ul())
```
